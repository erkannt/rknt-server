version: '3'

services:
  restic:
    image: restic/restic@sha256:2dabe80875cb32c3a8c029202f0fadb27d5e2192e0bf1fab377e7564b77cbbab
    volumes:
      - /var/volumes:/volumes
    environment:
      - RESTIC_PASSWORD=${RESTIC_PASSWORD}
      - RESTIC_REPOSITORY=${RESTIC_REPOSITORY}
      - AWS_ACCESS_KEY_ID=${RESTIC_S3_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${RESTIC_S3_SECRET_ACCESS_KEY}
    entrypoint: |
      ash -c 'ash -s <<EOF
      trap "break;exit" SIGHUP SIGINT SIGTERM

      echo "`date` restic init..."
      restic init

      while /bin/true; do
        echo "`date` starting backup..."
        restic backup --exclude /volumes/airsonic /volumes \
        && curl ${BACKUP_HEALTHCHECK_URL}
        sleep 3600
      done

      EOF'
